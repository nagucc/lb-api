{"version":3,"file":null,"sources":["../src/config.js","../src/handlers/command-handler.js","../src/handlers/device/cpu-usage.js","../src/handlers/device/memory.js","../src/handlers/device/index.js","../src/models/device-manager.js","../src/controllers/device.js","../src/controllers/index.js","../src/index.js"],"sourcesContent":["import debug from 'debug';\n\n// debug\nexport const error = debug('lb-api:error');\nexport const info = debug('lb-api:info');\n\nexport const sshOptions = {\n  host: process.env.LB_SSH_HOST,\n  port: process.env.LB_SSH_PORT || 22,\n  username: process.env.LB_SSH_USER,\n  password: process.env.LB_SSH_PASS,\n  algorithms: {\n    cipher: ['aes128-cbc'],\n  },\n};\nexport const port = process.env.PORT || 3000;\nexport const host = process.env.WEBSITE_HOSTNAME || `localhost:${port}`;\nexport const cookieKey = process.env.COOKIE_KEY || 'my cookie key';\n","export default class CommandHandler {\n  constructor(cmd, handler) {\n    this.command = cmd;\n    if (handler) this.handle = handler;\n  }\n  handle() {\n    return null;\n  }\n}\n","import CommandHandler from '../command-handler';\nimport { error, info } from '../../config';\n\n/*\n命令执行结果示例：\n<Sysname> display cpu-usage\nSlot 1 CPU 0 CPU usage:\n       6% in last 5 seconds\n      10% in last 1 minute\n       5% in last 5 minutes\n\nSlot 2 CPU 0 CPU usage:\n       15% in last 5 seconds\n       8% in last 1 minute\n       25% in last 5 minutes\n */\nconst parseCpuInfo = (data) => {\n  const reg = /Slot (\\d) CPU (\\d).+:\\r*\\n\\s+(\\d+)%.+5 seconds\\r*\\n\\s+(\\d+)%.+1 minute\\r*\\n\\s+(\\d+)%.+5 minutes/gm;\n  const result = reg.exec(data);\n  return {\n    slot: parseInt(result[1], 10),\n    number: parseInt(result[2], 10),\n    usage: {\n      last5s: parseInt(result[3], 10) / 100,\n      last1m: parseInt(result[4], 10) / 100,\n      last5m: parseInt(result[5], 10) / 100,\n    },\n  };\n};\n\nexport default new CommandHandler('display cpu-usage', (data) => {\n  info('Text for test:', JSON.stringify(data));\n  const result = {};\n  const slotTexts = data.match(/Slot \\d CPU \\d CPU.+\\r*\\n(.*\\r*\\n){2}.*last 5 minutes/gm);\n  info('SlotTexts =', slotTexts);\n  result.cpus = slotTexts.map(text => parseCpuInfo(text));\n  return result;\n});\n","import CommandHandler from '../command-handler';\nimport { info } from '../../config';\n\n/*\n命令执行结果示例：\n<Sysname> display memory\nThe statistics about memory is measured in KB:\nSlot 0:\n             Total      Used      Free    Shared   Buffers    Cached   FreeRatio\nMem:        507980    154896    353084         0       488     54488       69.5%\n-/+ Buffers/Cache:     99920    408060\nSwap:           0         0         0\n */\n\n// 目前仅支持单slot\nexport default new CommandHandler('display memory', (data) => {\n  info('Text for test:', JSON.stringify(data));\n  const reg = /Slot (\\d+):.*\\r*\\n.+\\r*\\n\\s*Mem\\D+(\\d+)\\s+(\\d+)\\s+(\\d+)/gm;\n  const result = reg.exec(data);\n  return {\n    slot: parseInt(result[1], 10),\n    memory: {\n      total: parseInt(result[2], 10),\n      used: parseInt(result[3], 10),\n      free: parseInt(result[4], 10),\n    },\n  };\n});\n","import cpuUsage from './cpu-usage';\nimport memory from './memory';\n\nexport default {\n  cpuUsage,\n  memory,\n};\n","import { Client } from 'ssh2';\nimport debug from 'debug';\nimport handlers from '../handlers/device/index';\n\nconst info = debug('lb-api:info');\nexport default class DeviceManager {\n  constructor(sshOptions) {\n    this.sshOptions = sshOptions;\n  }\n\n  /*\n登录ssh，并执行命令\n   */\n  run(commandHandler) {\n    const conn = new Client();\n    return new Promise((resolve, reject) => {\n      conn.on('ready', () => {\n        info('Client :: ready');\n        let str = '';\n        conn.shell((err, stream) => {\n          if (err) reject(err);\n          stream.on('close', () => {\n            conn.end();\n          }).on('data', (data) => {\n            str += data;\n          }).stderr.on('data', (data) => {\n            reject(data);\n          }).on('end', () => {\n            const result = commandHandler.handle(str);\n            resolve(result);\n          });\n          stream.write('screen-length disable\\n');\n          stream.write(`${commandHandler.command}\\n`);\n          stream.end('exit\\n');\n        });\n      }).connect(this.sshOptions);\n    });\n  }\n\n  cpuUsage() {\n    return this.run(handlers.cpuUsage);\n  }\n\n  /*\n获取内存数据\n   */\n  memory() {\n    return this.run(handlers.memory);\n  }\n}\n","/*\n eslint-disable no-param-reassign\n*/\n\nimport { Router } from 'express';\nimport DeviceManager from '../models/device-manager';\nimport { sshOptions, info } from '../config';\nconst router = new Router();\n\n/*\n获取当前设备CPU使用信息\n */\nrouter.get('/cpu-usage', async (req, res) => {\n  const manager = new DeviceManager(sshOptions);\n  const data = await manager.cpuUsage();\n  res.json({\n    ret: 0,\n    data,\n  });\n});\n\n/*\n获取当前设备内存使用信息\n */\nrouter.get('/memory', async (req, res) => {\n  const manager = new DeviceManager(sshOptions);\n  const data = await manager.memory();\n  res.json({\n    ret: 0,\n    data,\n  });\n});\n\nexport default router;\n","import device from './device';\n\nexport default {\n  device,\n};\n","/**\n * Babel Starter Kit (https://www.kriasoft.com/babel-starter-kit)\n *\n * Copyright © 2015-2016 Kriasoft, LLC. All rights reserved.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE.txt file in the root directory of this source tree.\n */\n\nimport 'babel-polyfill';\nimport express from 'express';\nimport cookieParser from 'cookie-parser';\nimport bodyParser from 'body-parser';\nimport { host, port, cookieKey } from './config';\nimport controllers from './controllers/index';\n\nconst app = express();\n\n//\n// Register Node.js middleware\n// -----------------------------------------------------------------------------\napp.use(cookieParser(cookieKey));\napp.use(bodyParser.urlencoded({ extended: true }));\napp.use(bodyParser.json({ limit: '50mb' }));\napp.use(bodyParser.urlencoded({ limit: '50mb', extended: true }));\n\nconst morgan = require('morgan');\napp.use(morgan('dev'));\n\n/*\n注册API\n*/\napp.use('/device', controllers.device);\n\napp.listen(port, () => {\n  console.log(`The server is running at http://${host}/`);\n});\n"],"names":["error","debug","info","sshOptions","process","env","LB_SSH_HOST","LB_SSH_PORT","LB_SSH_USER","LB_SSH_PASS","port","PORT","host","WEBSITE_HOSTNAME","cookieKey","COOKIE_KEY","CommandHandler","cmd","handler","command","handle","parseCpuInfo","data","reg","result","exec","parseInt","slotTexts","match","cpus","map","text","DeviceManager","commandHandler","conn","Client","resolve","reject","on","str","shell","err","stream","end","stderr","write","connect","run","handlers","cpuUsage","memory","router","Router","get","req","res","manager","json","app","express","use","cookieParser","bodyParser","urlencoded","extended","limit","morgan","require","controllers","device","listen","log"],"mappings":"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"}